# 1、网络协议和通讯协议

## 1.1三次握手

### 1. **第一次握手（SYN）**

- 客户端向服务器发送一个SYN（Synchronize）报文，用来请求建立连接。
- 在SYN报文中，客户端会选择一个初始序列号`Seq=X`，用于之后的数据传输，同时将SYN标志位设为1。
- 发送这个SYN报文后，客户端会进入**SYN-SENT**状态，等待服务器的响应。

### 2. **第二次握手（SYN-ACK）**

- 服务器接收到客户端的SYN报文后，知道客户端想要建立连接。
- 服务器向客户端发送一个SYN-ACK（Synchronize-Acknowledge）报文，对客户端的SYN请求进行确认。
- 在SYN-ACK报文中，服务器选择一个自己的初始序列号`Seq=Y`，并将SYN标志位设为1，同时将ACK标志位设为1，用来确认客户端的序列号`X`。因此，服务器会在ACK字段中设置`Ack=X+1`，表示已确认客户端的SYN报文。
- 发送SYN-ACK报文后，服务器进入**SYN-RECEIVED**状态，等待客户端的确认。

### 3. **第三次握手（ACK）**

- 客户端接收到服务器的SYN-ACK报文后，知道服务器已经收到自己的连接请求，并同意建立连接。
- 客户端向服务器发送一个ACK（Acknowledge）报文，确认服务器的序列号`Y`。
- 在ACK报文中，客户端将ACK标志位设为1，确认服务器的序列号，因此在ACK字段中设置`Ack=Y+1`，并使用自己的序列号`Seq=X+1`。
- 发送ACK报文后，客户端进入**ESTABLISHED**状态，表示连接已建立。
- 服务器在接收到客户端的ACK报文后，也会进入**ESTABLISHED**状态，至此，三次握手完成，TCP连接正式建立。







## 1.2四次断开

### 1. **第一次挥手（FIN）**

- 主动关闭方（例如客户端）发送一个FIN（Finish）报文，用来表示不再发送数据，但仍可以接收来自另一方的数据。
- 在FIN报文中，客户端将序列号设置为`Seq=U`，并将FIN标志位设为1，表示“我已发送完数据，请求关闭连接”。
- 发送FIN后，客户端进入**FIN-WAIT-1**状态，等待服务器的确认。

### 2. **第二次挥手（ACK）**

- 被动关闭方（例如服务器）接收到FIN报文后，发送一个ACK（Acknowledge）报文，对客户端的FIN报文进行确认。
- 在ACK报文中，服务器的序列号为`Seq=V`，ACK确认号为`Ack=U+1`，表示“我已收到你的关闭请求”。
- 发送ACK报文后，服务器进入**CLOSE-WAIT**状态，表示需要完成剩余的数据传输再关闭连接。
- 客户端接收到服务器的ACK报文后，进入**FIN-WAIT-2**状态，等待服务器的FIN报文。

### 3. **第三次挥手（FIN）**

- 服务器在发送完剩余的数据后，向客户端发送一个FIN报文，表示数据已发送完毕，准备关闭连接。
- 服务器将FIN标志位设为1，序列号为`Seq=W`。
- 发送FIN后，服务器进入**LAST-ACK**状态，等待客户端的最终确认。

### 4. **第四次挥手（ACK）**

- 客户端接收到服务器的FIN报文后，发送一个ACK报文，确认服务器的FIN。
- 在ACK报文中，客户端设置ACK确认号为`Ack=W+1`，表示“我已收到你的关闭请求，确认关闭连接”。
- 客户端在发送ACK报文后，进入**TIME-WAIT**状态，并保持一段时间（通常为2*MSL，即最大报文段生存时间）以确保服务器能收到ACK报文。
- 在等待时间结束后，客户端进入**CLOSED**状态，完全关闭连接。
- 服务器接收到ACK报文后，立即进入**CLOSED**状态，连接关闭。

三次握手四次断开



## 1.3滑动窗口

**滑动窗口**（Sliding Window）是TCP协议中用于流量控制和保证数据可靠性的一种机制。它通过限制发送方在等待确认之前可以发送的数据量，防止网络拥塞并确保接收方可以处理数据的能力。滑动窗口机制帮助管理数据的发送和接收过程，确保数据能够按序列号进行可靠传输。

### 滑动窗口的基本概念

在TCP连接中，滑动窗口涉及到两个主要的部分：

1. **发送窗口**（Sender Window）：发送方能够发送但尚未收到确认的数据范围。发送方会将数据分成多个段，并在发送数据后等待确认。
2. **接收窗口**（Receiver Window）：接收方能够接收并存储数据的范围，通常由接收方的缓冲区大小决定。

### 滑动窗口的工作原理

1. **窗口大小**：TCP滑动窗口的大小是动态变化的，接收方通过TCP报文的窗口大小字段告诉发送方当前可以接收的数据量（即接收窗口的大小）。窗口大小反映了接收方剩余的缓冲区容量。
2. **发送方控制窗口**：发送方根据接收方的窗口大小，控制自己可以发送的数据量。发送方只能在接收方未确认的数据范围内发送数据，不超过接收窗口的大小。
3. **确认和滑动**：每当接收方成功接收并确认某个数据段后，发送方的窗口就会向前滑动，释放出已确认的数据位置，发送方可以继续发送新的数据。滑动的过程是动态的，随着数据的确认，窗口向前“滑动”，从而允许更多数据的发送。

### 例子说明

假设发送方窗口大小为4个数据段（每个数据段为1个字节），接收方的窗口大小是2个数据段。以下是一个简单的示例：

1. **初始状态**：
   - 发送方的滑动窗口有4个数据段可以发送。
   - 接收方的接收窗口是2个数据段。
2. **发送数据**：
   - 发送方将第1、2、3、4个数据段发送出去。
   - 由于接收方的窗口大小是2个数据段，它只能接收前两个数据段。
3. **接收确认**：
   - 接收方接收第1和第2个数据段后，发送确认ACK给发送方。
   - 发送方收到确认后，窗口向前滑动，释放出已确认的数据段。
4. **发送更多数据**：
   - 发送方此时可以继续发送第5和第6个数据段，因为第1和第2个数据段已确认。
5. **继续滑动**：
   - 当接收方继续处理并确认更多数据段后，发送方的窗口不断滑动，可以发送更多数据。

### 发送窗口与接收窗口

- **发送方窗口**：它决定了发送方在等待确认前可以发送多少数据。这个窗口的大小由接收方的窗口大小和当前的网络状况（如网络拥塞控制算法）共同决定。
- **接收方窗口**：它由接收方的缓冲区大小决定，告诉发送方它最多可以接收多少数据。接收方的窗口会根据缓冲区的剩余空间动态调整。

### 滑动窗口的优势

1. **提高数据传输效率**：滑动窗口允许发送方在等待确认时可以发送多个数据段，避免了每发送一个数据段就等待确认的低效情况。
2. **避免拥塞**：通过控制发送方的发送速率，滑动窗口可以有效地避免网络拥塞，减少丢包率。
3. **确保数据有序性和可靠性**：滑动窗口确保了数据包的顺序，并在丢包或错误发生时，能够通过重传机制恢复数据。

### 滑动窗口的动态调整

在实际操作中，滑动窗口的大小是动态变化的，通常由接收方的接收能力和网络拥塞状态决定：

- **接收方调整窗口大小**：如果接收方的缓冲区空间不足，它可能会告知发送方减小窗口大小，减少发送的数据量，避免数据丢失。
- **发送方根据窗口大小调整**：发送方根据接收方的窗口大小来调整自己发送的速率。如果窗口小，它会减少发送的数据量，直到接收方能够处理更多数据。

### TCP中的窗口大小字段

在TCP报文头中，有一个名为**窗口大小（Window Size）**的字段，它用于表示接收方可用的缓冲区大小，即接收窗口的大小。这个值告诉发送方应该发送多少数据。如果窗口大小为0，则发送方必须暂停发送数据，直到接收方通知它可以继续发送。

### 总结

滑动窗口是TCP协议的核心机制之一，确保了数据可靠、高效的传输。它通过动态调整窗口大小，使得发送方能够在网络条件允许的范围内发送大量数据，同时避免了网络拥塞和数据丢失。













## 三次握手和四次断开的状态

1. **CLOSED（关闭）**
   **状态描述**：表示TCP连接处于“关闭”状态，无活动的连接。初始状态。
2. **LISTEN（监听）**
   **状态描述**：服务器端等待客户端发送SYN请求建立连接的状态。
3. **SYN-SENT（同步已发送）**
   **状态描述**：客户端发送SYN请求后进入此状态，等待服务器的SYN-ACK确认。
4. **SYN-RECEIVED（同步已接收）**
   **状态描述**：服务器收到客户端的SYN请求后，发送SYN-ACK响应，并等待客户端的ACK确认。
5. **ESTABLISHED（已建立）**
   **状态描述**：客户端和服务器都已成功接收和确认SYN，连接已建立，可以进行数据传输。
6. **FIN-WAIT-1（终止等待1）**
   **状态描述**：主动关闭方（客户端或服务器）发送FIN请求断开连接后的状态，等待对方的ACK确认。
7. **FIN-WAIT-2（终止等待2）**
   **状态描述**：主动关闭方接收到对方的ACK确认后进入此状态，等待对方的FIN请求以完成连接的关闭。
8. **CLOSE-WAIT（关闭等待）**
   **状态描述**：被动关闭方接收到FIN请求后的状态，等待应用层处理并发送ACK确认。
9. **CLOSING（正在关闭）**
   **状态描述**：主动关闭方在发送FIN后没有收到ACK，而是接收到对方的FIN报文，表示双方同时尝试关闭连接，等待彼此确认。
10. **LAST-ACK（最后确认）**
    **状态描述**：被动关闭方在发送FIN请求并等待对方的ACK确认后的状态，完成最后的连接关闭。
11. **TIME-WAIT（时间等待）**
    **状态描述**：主动关闭方发送ACK确认后进入的状态，保持2*MSL（最大报文段生存时间），防止延迟的报文影响新连接，超时后进入CLOSED状态。

### TCP连接状态转换概览

- **连接建立**：CLOSED → SYN-SENT → SYN-RECEIVED → ESTABLISHED

- **连接关闭**：ESTABLISHED → FIN-WAIT-1 → FIN-WAIT-2 → TIME-WAIT

  